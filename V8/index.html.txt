<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–ö–≤–µ—Å—Ç 2026 ‚Äì –ö–æ–ª–æ–Ω–∏–∑–∞—Ü–∏—è –Æ–ø–∏—Ç–µ—Ä–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== –û–ë–©–ò–ï –°–¢–ò–õ–ò ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }

        :root {
            --space-dark: #0b0d1e;
            --space-purple: #1a1a3a;
            --neon-blue: #4e54f5;
            --neon-cyan: #3dc2ec;
            --neon-pink: #f72585;
            --neon-green: #06d6a0;
            --star-color: rgba(255,255,255,0.9);
            --card-bg: rgba(20,25,45,0.9);
            --text-light: #f0f0f0;
            --text-dim: #aaa;
            --blur-amount: 3px;
        }

        body {
            background: radial-gradient(ellipse at top, #1a1a3a, #0a0a1a);
            min-height: 100vh;
            padding: 8px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(2px 2px at 10px 20px, var(--star-color), transparent),
                radial-gradient(2px 2px at 30px 70px, var(--star-color), transparent),
                radial-gradient(3px 3px at 80px 40px, var(--star-color), transparent),
                radial-gradient(1px 1px at 150px 180px, var(--star-color), transparent),
                radial-gradient(2px 2px at 250px 300px, var(--star-color), transparent),
                radial-gradient(3px 3px at 350px 150px, var(--star-color), transparent);
            background-repeat: repeat;
            pointer-events: none;
            z-index: -1;
            animation: twinkle 4s infinite alternate;
        }

        @keyframes twinkle { 0% { opacity: 0.7; } 100% { opacity: 1; } }

        .container { max-width: 1400px; margin: 0 auto; }

        .app {
            background: rgba(10,15,30,0.7);
            backdrop-filter: blur(12px);
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            overflow: hidden;
            min-height: 90vh;
            color: var(--text-light);
        }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; gap: 10px;
        }

        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 45px; height: 45px; background: linear-gradient(145deg, var(--neon-blue), var(--neon-cyan));
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; box-shadow: 0 0 15px var(--neon-blue);
        }
        .logo-text h1 {
            font-size: 20px; font-weight: 600; background: linear-gradient(135deg, #fff, #b0b0ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .logo-text p { font-size: 12px; color: var(--text-dim); }

        .user-info {
            display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.5);
            padding: 6px 15px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.15);
        }
        .impulse-badge {
            background: linear-gradient(145deg, var(--neon-green), #0a9); color: #000;
            font-weight: bold; padding: 5px 12px; border-radius: 30px; font-size: 14px;
            display: flex; align-items: center; gap: 6px; box-shadow: 0 0 12px var(--neon-green);
        }

        .btn {
            padding: 10px 20px; border: none; border-radius: 40px; font-size: 15px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            touch-action: manipulation;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.5); border-color: var(--neon-cyan); }
        .btn-primary { background: linear-gradient(145deg, var(--neon-blue), #3a3fd4); border: none; }
        .btn-success { background: linear-gradient(145deg, var(--neon-green), #059669); border: none; }
        .btn-danger { background: linear-gradient(145deg, var(--neon-pink), #c41e6b); border: none; }
        .btn-info { background: linear-gradient(145deg, #17a2b8, #117a8b); border: none; }
        .btn-outline { background: transparent; border: 2px solid var(--neon-cyan); color: var(--neon-cyan); }
        .btn-warning { background: linear-gradient(145deg, #f8961e, #e07c0c); border: none; }

        .tabs {
            display: flex; gap: 4px; background: rgba(0,0,0,0.3); padding: 6px;
            border-radius: 50px; margin-bottom: 20px; overflow-x: auto; flex-wrap: nowrap;
        }
        .tab-btn {
            padding: 8px 16px; border-radius: 40px; background: transparent;
            border: none; color: var(--text-dim); font-weight: 600; cursor: pointer;
            transition: 0.2s; font-size: 14px; white-space: nowrap;
            touch-action: manipulation;
        }
        .tab-btn.active { background: var(--neon-blue); color: white; box-shadow: 0 0 12px var(--neon-blue); }

        .dashboard { padding: 20px; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: var(--card-bg);
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        .stat-content {
            padding: 18px;
            transition: filter 0.2s, opacity 0.2s;
        }
        .stat-content.blurred {
            filter: blur(var(--blur-amount));
            opacity: 0.5;
        }
        .lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: rgba(255,255,255,0.5);
            pointer-events: none;
            z-index: 2;
        }
        .stat-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .stat-icon {
            width: 45px; height: 45px; border-radius: 18px; background: rgba(78,84,245,0.2);
            display: flex; align-items: center; justify-content: center; font-size: 22px;
            color: var(--neon-cyan);
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, #fff, #b0b0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
            margin-top: 15px;
        }
        .product-card {
            background: var(--card-bg); border-radius: 25px; padding: 18px;
            border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(5px);
            transition: 0.2s; display: flex; flex-direction: column; align-items: center;
            text-align: center;
        }
        .product-card:hover { transform: translateY(-4px); border-color: var(--neon-cyan); box-shadow: 0 10px 25px rgba(0,255,255,0.15); }
        .product-icon {
            width: 80px; height: 80px; background: rgba(78,84,245,0.2);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: var(--neon-cyan); margin-bottom: 15px;
            border: 2px solid transparent; transition: 0.2s;
        }
        .product-card:hover .product-icon { border-color: var(--neon-cyan); box-shadow: 0 0 25px var(--neon-cyan); }
        .product-name { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .product-description { font-size: 13px; color: var(--text-dim); margin-bottom: 15px; }
        .product-details {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 10px;
            width: 100%;
            text-align: left;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 8px;
        }
        .product-details i {
            width: 20px;
            color: var(--neon-cyan);
        }
        .product-price {
            font-size: 20px; font-weight: 700; color: var(--neon-green);
            margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-buy {
            width: 100%; padding: 12px; border-radius: 40px;
            background: linear-gradient(145deg, var(--neon-blue), #3a3fd4);
            border: none; color: white; font-weight: 600; font-size: 14px;
            cursor: pointer; transition: 0.2s;
            touch-action: manipulation;
        }
        .btn-buy:hover { transform: scale(1.02); box-shadow: 0 0 15px var(--neon-blue); }
        .btn-buy:disabled { opacity: 0.5; pointer-events: none; }

        .category-header {
            grid-column: 1 / -1;
            font-size: 1.5rem;
            margin: 20px 0 10px;
            border-bottom: 2px solid var(--neon-cyan);
            padding-bottom: 5px;
            color: var(--neon-cyan);
            text-transform: uppercase;
        }

        .table-container {
            background: var(--card-bg); border-radius: 25px; padding: 16px;
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th {
            text-align: left; padding: 12px; background: rgba(0,0,0,0.3);
            color: var(--neon-cyan); font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 14px;
        }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; color: var(--text-light); }

        tr:hover { background: rgba(255,255,255,0.03); }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card-bg); border-radius: 30px; padding: 25px;
            max-width: 95%; width: 500px; border: 1px solid rgba(255,255,255,0.1);
            max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: white; font-size: 20px; }
        .modal-close { background: none; border: none; font-size: 28px; color: var(--text-dim); cursor: pointer; }
        .modal-close:hover { color: white; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-dim); font-weight: 500; font-size: 14px; }
        .form-control {
            width: 100%; padding: 14px 18px; border-radius: 40px; border: none;
            background: rgba(0,0,0,0.5); color: white; font-size: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .form-control:focus { outline: none; border-color: var(--neon-cyan); }

        .notification {
            position: fixed; bottom: 20px; right: 20px; padding: 14px 25px;
            border-radius: 50px; background: var(--card-bg); border-left: 6px solid var(--neon-green);
            color: white; font-weight: 600; z-index: 2000; display: none;
            animation: slideIn 0.3s; backdrop-filter: blur(10px); box-shadow: 0 8px 25px black;
            font-size: 14px; max-width: 90%;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.success { border-left-color: var(--neon-green); }
        .notification.error { border-left-color: var(--neon-pink); }
        .notification.warning { border-left-color: #f8961e; }

        .btn-icon { padding: 8px 10px; margin: 0 2px; font-size: 14px; }

        .status-badge {
            display: inline-block; padding: 3px 8px; border-radius: 20px;
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            background: rgba(0,0,0,0.5);
            color: var(--text-light) !important;
        }
        .status-badge.–∫—É–ø–ª–µ–Ω–æ { color: #aaa !important; border: 1px solid #aaa; animation: pulse-white 2s infinite; }
        .status-badge.—Å—Ç—Ä–æ–∏—Ç—Å—è { color: #f8961e !important; border: 1px solid #f8961e; }
        .status-badge.—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç { color: #06d6a0 !important; border: 1px solid #06d6a0; }

        @keyframes pulse-white {
            0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255,255,255,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
        }

        .pulse-awaiting {
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .food-warning {
            background: rgba(255, 100, 100, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            display: none;
        }
        .staff-warning {
            background: rgba(255, 165, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            display: none;
        }
        .event-banner {
            background: rgba(78, 84, 245, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            display: none;
        }

        .final-panel {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.5s;
        }

        .final-content {
            background: var(--card-bg);
            border-radius: 40px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            border: 2px solid var(--neon-cyan);
            box-shadow: 0 0 50px var(--neon-cyan);
            text-align: center;
        }

        .final-title {
            font-size: 2rem;
            color: var(--neon-cyan);
            margin-bottom: 30px;
            text-transform: uppercase;
        }

        .final-stats {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .final-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 15px 20px;
            border-radius: 50px;
            font-size: 1.3rem;
        }

        .final-total {
            background: linear-gradient(145deg, var(--neon-blue), var(--neon-cyan));
            color: black;
            font-weight: bold;
            box-shadow: 0 0 20px var(--neon-cyan);
        }

        .final-label {
            color: var(--text-dim);
        }

        .final-value {
            font-weight: 700;
        }

        .final-place {
            font-size: 1.5rem;
            margin-bottom: 30px;
            color: var(--neon-green);
        }

        .timer {
            background: rgba(0,0,0,0.4);
            padding: 6px 12px;
            border-radius: 30px;
            font-family: monospace;
            font-size: 18px;
            font-weight: bold;
            color: var(--neon-cyan);
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan);
            letter-spacing: 2px;
        }
        .timer.warning {
            color: #f8961e;
            border-color: #f8961e;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } }

        .satiety-emoji {
            font-size: 32px;
            line-height: 1;
            display: inline-block;
            filter: none;
        }

        @media (max-width: 600px) {
            .header { flex-direction: column; align-items: stretch; padding: 10px; }
            .logo-text h1 { font-size: 18px; }
            .logo-text p { font-size: 10px; }
            .user-info { flex-wrap: wrap; justify-content: center; }
            .impulse-badge { font-size: 12px; padding: 4px 8px; }
            .tabs { gap: 2px; }
            .tab-btn { padding: 8px 10px; font-size: 13px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-content { padding: 12px; }
            .stat-icon { width: 35px; height: 35px; font-size: 18px; }
            .stat-value { font-size: 24px; }
            .stat-label { font-size: 10px; }
            .shop-grid { grid-template-columns: 1fr; }
            .product-card { padding: 15px; }
            .product-icon { width: 60px; height: 60px; font-size: 30px; }
            .modal-content { padding: 20px; width: 95%; }
            .btn { padding: 12px 16px; font-size: 16px; }
            .timer { font-size: 16px; padding: 4px 8px; }
            .final-title { font-size: 1.5rem; }
            .final-stat { font-size: 1rem; padding: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app">
            <!-- ========== –≠–ö–†–ê–ù –í–•–û–î–ê ========== -->
            <div id="loginScreen" class="screen active">
                <div class="header">
                    <div class="logo">
                        <div class="logo-icon"><i class="fas fa-rocket"></i></div>
                        <div class="logo-text">
                            <h1>–ö–≤–µ—Å—Ç 2026</h1>
                            <p>–ö–æ–ª–æ–Ω–∏–∑–∞—Ü–∏—è –Æ–ø–∏—Ç–µ—Ä–∞</p>
                        </div>
                    </div>
                    <div class="version" style="color: var(--text-dim);">v6.18</div>
                </div>
                <div style="display: flex; justify-content: center; align-items: center; min-height: 60vh; padding: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px; width: 100%; max-width: 400px;">
                        <!-- –í—Ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã -->
                        <div class="stat-card" style="text-align: center;">
                            <div class="stat-icon" style="margin: 0 auto 15px;"><i class="fas fa-users"></i></div>
                            <h2 style="margin-bottom: 15px;">–£—á–∞—Å—Ç–Ω–∏–∫</h2>
                            <p style="margin-bottom: 20px; color: var(--text-dim);">–í–æ–π–¥–∏—Ç–µ –ø–æ –∫–æ–¥—É –∫–æ–º–∞–Ω–¥—ã</p>
                            <div class="form-group">
                                <input type="text" id="teamCodeInput" class="form-control" placeholder="–ö–æ–¥ (6 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="6">
                            </div>
                            <button onclick="loginAsTeam()" class="btn btn-primary" style="width:100%;">
                                <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                            </button>
                        </div>
                        <!-- –í—Ö–æ–¥ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞ -->
                        <div class="stat-card" style="text-align: center;">
                            <div class="stat-icon" style="margin: 0 auto 15px;"><i class="fas fa-crown"></i></div>
                            <h2 style="margin-bottom: 15px;">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</h2>
                            <p style="margin-bottom: 20px; color: var(--text-dim);">–î–æ—Å—Ç—É–ø –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é</p>
                            <div class="form-group">
                                <input type="password" id="adminPasswordInput" class="form-control" placeholder="–ü–∞—Ä–æ–ª—å">
                            </div>
                            <button onclick="loginAsAdmin()" class="btn btn-success" style="width:100%;">
                                <i class="fas fa-lock"></i> –í–æ–π—Ç–∏
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== –≠–ö–†–ê–ù –£–ß–ê–°–¢–ù–ò–ö–ê ========== -->
            <div id="teamScreen" class="screen">
                <div class="header">
                    <div class="logo">
                        <button onclick="logout()" class="btn btn-outline" style="padding: 8px 12px;"><i class="fas fa-arrow-left"></i></button>
                        <div class="logo-icon"><i class="fas fa-galaxy"></i></div>
                        <div class="logo-text">
                            <h1 id="teamNameHeader">–ö–æ–º–∞–Ω–¥–∞</h1>
                            <p>–ò–º–ø—É–ª—å—Å—ã: <span id="teamScoreHeader">0</span></p>
                        </div>
                    </div>
                    <div class="user-info">
                        <span class="impulse-badge"><i class="fas fa-bolt"></i> <span id="teamScoreBadge">0</span></span>
                        <span id="epochDisplay" style="font-size:12px; background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:20px;">‚ö° –ó–∞—Ä—è</span>
                        <span id="timerDisplay" class="timer">30:00</span>
                        <button onclick="refreshTeamData()" class="btn" style="padding:8px;"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>

                <div class="dashboard">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchTeamTab('dashboard')">üìä –î–∞—à–±–æ—Ä–¥</button>
                        <button class="tab-btn" onclick="switchTeamTab('shop')">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
                        <button class="tab-btn" onclick="switchTeamTab('inventory')">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
                        <button class="tab-btn" onclick="switchTeamTab('finance')">üí∞ –§–∏–Ω–∞–Ω—Å—ã</button>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –î–ê–®–ë–û–†–î -->
                    <div id="teamDashboardTab" style="display: block;">
                        <div class="stats-grid" id="dashboardStats"></div>

                        <div id="foodWarning" class="food-warning">
                            <i class="fas fa-exclamation-triangle" style="color: #ff6b6b;"></i>
                            <span id="foodWarningText"></span>
                        </div>

                        <div id="staffWarning" class="staff-warning">
                            <i class="fas fa-users" style="color: #ffa500;"></i>
                            <span id="staffWarningText"></span>
                        </div>

                        <div id="currentEvent" class="event-banner">
                            <i class="fas fa-dice"></i> <strong>–°–æ–±—ã—Ç–∏–µ —Å–µ–∑–æ–Ω–∞:</strong> <span id="eventText"></span>
                        </div>

                        <div id="contractContainer" class="table-container" style="display: none;">
                            <h3 style="margin-bottom:15px;"><i class="fas fa-file-contract"></i> –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç</h3>
                            <div id="contractInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                            <button onclick="checkContract()" class="btn btn-warning" style="margin-top:10px;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
                        </div>

                        <div class="table-container">
                            <h3 style="margin-bottom:15px;"><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</h3>
                            <div id="historyTable">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>

                        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞ ‚Äì —Å–∫—Ä—ã—Ç, –µ—Å–ª–∏ –Ω–µ—Ç —Ä–∞–∑–≤–µ–¥–ø—É–Ω–∫—Ç–∞ -->
                        <div class="table-container" id="ratingContainer" style="display: none;">
                            <h3 style="margin-bottom:15px;"><i class="fas fa-chart-line"></i> –†–µ–π—Ç–∏–Ω–≥ –∫–æ–º–∞–Ω–¥</h3>
                            <div id="ratingTable">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –ú–ê–ì–ê–ó–ò–ù -->
                    <div id="teamShopTab" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2><i class="fas fa-store"></i> –ó–¥–∞–Ω–∏—è –Æ–ø–∏—Ç–µ—Ä–∞</h2>
                            <span class="impulse-badge">–ë–∞–ª–∞–Ω—Å: <span id="shopImpulseBalance">0</span></span>
                        </div>
                        <div id="shopFilters" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button class="btn btn-outline filter-btn active" data-type="all">–í—Å–µ</button>
                            <button class="btn btn-outline filter-btn" data-type="–∂–∏–ª—å—ë">–ñ–∏–ª—å—ë</button>
                            <button class="btn btn-outline filter-btn" data-type="—ç–Ω–µ—Ä–≥–∏—è">–≠–Ω–µ—Ä–≥–∏—è</button>
                            <button class="btn btn-outline filter-btn" data-type="–¥–æ–±—ã—á–∞">–î–æ–±—ã—á–∞</button>
                            <button class="btn btn-outline filter-btn" data-type="–µ–¥–∞">–ï–¥–∞</button>
                            <button class="btn btn-outline filter-btn" data-type="—Ç–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥">–¢–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥</button>
                            <button class="btn btn-outline filter-btn" data-type="–±—É—Å—Ç–µ—Ä">–ë—É—Å—Ç–µ—Ä</button>
                            <button class="btn btn-outline filter-btn" data-type="–∑–∞—â–∏—Ç–∞">–ó–∞—â–∏—Ç–∞</button>
                            <button class="btn btn-outline filter-btn" data-type="–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</button>
                            <button class="btn btn-outline filter-btn" data-type="—Ç–æ—Ç–µ–º">–¢–æ—Ç–µ–º</button>
                        </div>
                        <div id="shopItemsGrid" class="shop-grid">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –ò–ù–í–ï–ù–¢–ê–†–¨ -->
                    <div id="teamInventoryTab" style="display: none;">
                        <h2 style="margin-bottom: 15px;"><i class="fas fa-box"></i> –ú–æ–∏ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</h2>
                        <div id="inventoryGrid" class="shop-grid">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è...</div>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –§–ò–ù–ê–ù–°–´ -->
                    <div id="teamFinanceTab" style="display: none;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="investmentsValue">0</div>
                                <div class="stat-label">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ —Ñ–æ–Ω–¥</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="loanValue">0</div>
                                <div class="stat-label">–¢–µ–∫—É—â–∏–π –∫—Ä–µ–¥–∏—Ç</div>
                            </div>
                        </div>
                        <div class="table-container">
                            <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                            <div id="financeActions"></div>
                        </div>
                        <!-- –ë–ª–æ–∫ —Ç–æ—Ç–µ–º–∞ —Å –Ω–æ–≤–æ–π –∏–∫–æ–Ω–∫–æ–π -->
                        <div id="totemSection" style="display: none;" class="table-container">
                            <h3><i class="fas fa-feather"></i> –¢–æ—Ç–µ–º –∫–æ–ª–æ–Ω–∏–∏</h3>
                            <p>–í–Ω–µ—Å—ë–Ω–Ω—ã–π –Ω–æ–º–∏–Ω–∞–ª: <span id="totemInvested">0</span> ‚ö°</p>
                            <button onclick="totemContribute()" class="btn btn-warning">üôè –í–Ω–µ—Å—Ç–∏ –≤ —Ç–æ—Ç–µ–º</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== –≠–ö–†–ê–ù –û–†–ì–ê–ù–ò–ó–ê–¢–û–†–ê ========== -->
            <div id="adminScreen" class="screen">
                <div class="header">
                    <div class="logo">
                        <button onclick="logout()" class="btn btn-outline" style="padding:8px 12px;"><i class="fas fa-arrow-left"></i></button>
                        <div class="logo-icon"><i class="fas fa-crown"></i></div>
                        <div class="logo-text">
                            <h1>–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</h1>
                            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π</p>
                        </div>
                    </div>
                    <div class="user-info">
                        <span class="impulse-badge"><i class="fas fa-star"></i> –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø</span>
                        <button onclick="refreshAdminData()" class="btn" style="padding:8px;"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>

                <div class="dashboard">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchAdminTab('teams')">üë• –ö–æ–º–∞–Ω–¥—ã</button>
                        <button class="tab-btn" onclick="switchAdminTab('shop')">üõí –¢–æ–≤–∞—Ä—ã</button>
                        <button class="tab-btn" onclick="switchAdminTab('events')">üå©Ô∏è –°–æ–±—ã—Ç–∏—è</button>
                        <button class="tab-btn" onclick="switchAdminTab('final')">üèÜ –ò—Ç–æ–≥–∏</button>
                        <button class="tab-btn" onclick="switchAdminTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –ö–û–ú–ê–ù–î–´ -->
                    <div id="adminTeamsTab" style="display: block;">
                        <div class="table-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                                <h3><i class="fas fa-users"></i> –í—Å–µ –∫–æ–º–∞–Ω–¥—ã</h3>
                                <button onclick="showAddTeamModal()" class="btn btn-success"><i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å</button>
                                <button onclick="advanceEpoch()" class="btn btn-primary"><i class="fas fa-forward"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —ç–ø–æ—Ö—É</button>
                            </div>
                            <table>
                                <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>‚ö°</th><th>–ö—É–ø–ª–µ–Ω–æ</th><th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th><th>–ö–æ–¥</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                                <tbody id="teamsTableBody"></tbody>
                            </table>
                        </div>

                        <div class="stats-grid">
                            <div class="table-container">
                                <h3><i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ</h3>
                                <select id="quickTeamSelect" class="form-control" style="margin-bottom:12px;"></select>
                                <div style="display: grid; grid-template-columns: repeat(2,1fr); gap:8px;">
                                    <button onclick="quickAdd(10,'–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å')" class="btn btn-success">+10</button>
                                    <button onclick="quickAdd(20,'–ü–æ–±–µ–¥–∞')" class="btn btn-success">+20</button>
                                    <button onclick="quickAdd(50,'–û—Å–æ–±–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ')" class="btn btn-success">+50</button>
                                    <button onclick="quickAdd(-5,'–ó–∞–º–µ—á–∞–Ω–∏–µ')" class="btn btn-danger">-5</button>
                                </div>
                            </div>
                            <div class="table-container">
                                <h3><i class="fas fa-pen"></i> –†—É—á–Ω–æ–µ</h3>
                                <select id="manualTeamSelect" class="form-control" style="margin-bottom:12px;"></select>
                                <input type="number" id="pointsInput" class="form-control" placeholder="–ò–º–ø—É–ª—å—Å—ã" style="margin-bottom:12px;">
                                <input type="text" id="reasonInput" class="form-control" placeholder="–ü—Ä–∏—á–∏–Ω–∞" style="margin-bottom:12px;">
                                <button onclick="manualAddPoints()" class="btn btn-primary" style="width:100%;">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–û–í–ê–†–ê–ú–ò -->
                    <div id="adminShopTab" style="display: none;">
                        <div class="table-container">
                            <div style="display: flex; justify-content: space-between; margin-bottom:15px;">
                                <h3><i class="fas fa-boxes"></i> –¢–æ–≤–∞—Ä—ã</h3>
                                <button onclick="showAddItemModal()" class="btn btn-success"><i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                            <table>
                                <thead><tr><th>ID</th><th>–ò–∫–æ–Ω–∫–∞</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–¢–∏–ø</th><th>–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                                <tbody id="itemsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –°–û–ë–´–¢–ò–Ø -->
                    <div id="adminEventsTab" style="display: none;">
                        <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="table-container">
                                <h3><i class="fas fa-clock"></i> –†–∞—É–Ω–¥—ã</h3>
                                <p>–ù–∞—á–∏—Å–ª–∏—Ç—å –¥–æ—Ö–æ–¥ –∑–∞ —Å–µ–∑–æ–Ω (—É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è r, f, –±—É—Å—Ç–µ—Ä—ã)</p>
                                <button onclick="processRoundIncome()" class="btn btn-success" style="width:100%;">üöÄ –ù–∞—á–∏—Å–ª–∏—Ç—å –¥–æ—Ö–æ–¥ –∑–∞ —Å–µ–∑–æ–Ω</button>
                            </div>
                            <div class="table-container">
                                <h3><i class="fas fa-dice"></i> –ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</h3>
                                <select id="wheelSeason" class="form-control" style="margin-bottom:12px;">
                                    <option value="3">–°–µ–∑–æ–Ω 3</option>
                                    <option value="4">–°–µ–∑–æ–Ω 4</option>
                                    <option value="5">–°–µ–∑–æ–Ω 5</option>
                                    <option value="6">–°–µ–∑–æ–Ω 6</option>
                                </select>
                                <button onclick="spinWheel()" class="btn btn-primary" style="width:100%;">üé≤ –ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                                <h3><i class="fas fa-list"></i> –°–æ–±—ã—Ç–∏—è –∫–æ–ª–µ—Å–∞ —Ñ–æ—Ä—Ç—É–Ω—ã</h3>
                                <button onclick="showAddEventModal()" class="btn btn-success"><i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
                            </div>
                            <table>
                                <thead><tr><th>–¢–∏–ø</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                                <tbody id="eventsTableBody"></tbody>
                            </table>
                        </div>
                        <div class="table-container">
                            <h3><i class="fas fa-file-contract"></i> –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã</h3>
                            <select id="teamContractSelect" class="form-control" style="margin-bottom:12px;"></select>
                            <button onclick="assignContract()" class="btn btn-info">üìù –ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç</button>
                        </div>
                    </div>

                    <!-- –ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ –ò–¢–û–ì–ò -->
                    <div id="adminFinalTab" style="display: none;">
                        <div class="table-container">
                            <h3><i class="fas fa-trophy"></i> –ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã (–ø–æ—Å–ª–µ 7 —Å–µ–∑–æ–Ω–∞)</h3>
                            <p>–§–æ—Ä–º—É–ª–∞: –ò–º–ø—É–ª—å—Å—ã √ó –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫—Ä–∞—Å–æ—Ç—ã √ó (0.5 + –ò–Ω–¥–µ–∫—Å —Ç–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥–∞/100)</p>
                            <table id="finalScoresTable">
                                <thead>
                                    <tr><th>–ú–µ—Å—Ç–æ</th><th>–ö–æ–º–∞–Ω–¥–∞</th><th>–ò–º–ø—É–ª—å—Å—ã</th><th>–ò–Ω–¥–µ–∫—Å —Ç–µ—Ä—Ä.</th><th>–ö–æ—ç—Ñ. –∫—Ä–∞—Å–æ—Ç—ã</th><th>–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                                </thead>
                                <tbody id="finalScoresBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
                    <div id="adminStatsTab" style="display: none;">
                        <div class="stats-grid">
                            <div class="stat-card"><div class="stat-value" id="totalTeamsStat">0</div><div class="stat-label">–ö–æ–º–∞–Ω–¥</div></div>
                            <div class="stat-card"><div class="stat-value" id="totalImpulsesStat">0</div><div class="stat-label">–í—Å–µ–≥–æ –∏–º–ø—É–ª—å—Å–æ–≤</div></div>
                            <div class="stat-card"><div class="stat-value" id="totalPurchasesStat">0</div><div class="stat-label">–ü–æ–∫—É–ø–æ–∫</div></div>
                        </div>
                        <div class="table-container">
                            <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
                            <div id="recentTransactionsAdmin">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ========== -->
    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã -->
    <div id="addTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>–ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞</h2><button class="modal-close" onclick="closeModal('addTeamModal')">&times;</button></div>
            <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="newTeamName" class="form-control"></div>
            <div class="form-group"><label>–ö–æ–¥ (6 —Å–∏–º–≤–æ–ª–æ–≤)</label><input type="text" id="newTeamCode" class="form-control" maxlength="6"></div>
            <div class="form-group"><label>–ö–æ–Ω—Ç–∞–∫—Ç</label><input type="text" id="newTeamContact" class="form-control"></div>
            <button onclick="addTeam()" class="btn btn-primary" style="width:100%;">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã -->
    <div id="editTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</h2><button class="modal-close" onclick="closeModal('editTeamModal')">&times;</button></div>
            <input type="hidden" id="editTeamId">
            <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="editTeamName" class="form-control"></div>
            <div class="form-group"><label>–ö–æ–¥</label><input type="text" id="editTeamCode" class="form-control" maxlength="6"></div>
            <div class="form-group"><label>–ö–æ–Ω—Ç–∞–∫—Ç</label><input type="text" id="editTeamContact" class="form-control"></div>
            <div style="display:flex; gap:10px;"><button onclick="updateTeam()" class="btn btn-primary" style="flex:1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button onclick="deleteTeam()" class="btn btn-danger" style="flex:1;">–£–¥–∞–ª–∏—Ç—å</button></div>
        </div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (—Å –ø–æ–ª–µ–º "–ü–µ—Ä—Å–æ–Ω–∞–ª —Ç—Ä–µ–±—É–µ—Ç—Å—è") -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>–ù–æ–≤–æ–µ –∑–¥–∞–Ω–∏–µ</h2><button class="modal-close" onclick="closeModal('addItemModal')">&times;</button></div>
            <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="newItemName" class="form-control"></div>
            <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="newItemDesc" class="form-control"></div>
            <div class="form-group"><label>–¶–µ–Ω–∞</label><input type="number" id="newItemPrice" class="form-control"></div>
            <div class="form-group"><label>–ò–∫–æ–Ω–∫–∞ (Font Awesome)</label><input type="text" id="newItemIcon" class="form-control" value="fa-solid fa-question"></div>
            <div class="form-group"><label>–¢–∏–ø</label><input type="text" id="newItemType" class="form-control" value="–æ–±—â–µ–µ"></div>
            <div class="form-group"><label>–≠–Ω–µ—Ä–≥–∏—è –¥–∞—ë—Ç</label><input type="number" id="newItemEnergyProvides" class="form-control" value="0"></div>
            <div class="form-group"><label>–≠–Ω–µ—Ä–≥–∏—è –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç</label><input type="number" id="newItemEnergyCost" class="form-control" value="0"></div>
            <div class="form-group"><label>–ö–æ–ª–æ–Ω–∏—Å—Ç—ã –¥–∞—ë—Ç</label><input type="number" id="newItemColonistsProvides" class="form-control" value="0"></div>
            <div class="form-group"><label>–ï–¥–∞ –¥–∞—ë—Ç</label><input type="number" id="newItemFoodProvides" class="form-control" value="0"></div>
            <div class="form-group"><label>–ë–æ–Ω—É—Å —Ç–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥–∞</label><input type="number" id="newItemTerraformBonus" class="form-control" value="0"></div>
            <div class="form-group"><label><input type="checkbox" id="newItemProduction"> –î–æ—Ö–æ–¥–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</label></div>
            <div class="form-group"><label><input type="checkbox" id="newItemUnique"> –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ (—Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞)</label></div>
            <div class="form-group"><label>–ú–∞–∫—Å –Ω–∞ –∫–æ–º–∞–Ω–¥—É</label><input type="number" id="newItemMaxPerTeam" class="form-control" value="0"></div>
            <div class="form-group"><label>–≠—Ñ—Ñ–µ–∫—Ç (JSON)</label><textarea id="newItemEffect" class="form-control" rows="3">{}</textarea></div>
            <div class="form-group"><label>–ü–µ—Ä—Å–æ–Ω–∞–ª —Ç—Ä–µ–±—É–µ—Ç—Å—è</label><input type="number" id="newItemStaffRequired" class="form-control" value="0"></div>
            <button onclick="addItem()" class="btn btn-primary" style="width:100%;">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (—Å –ø–æ–ª–µ–º "–ü–µ—Ä—Å–æ–Ω–∞–ª —Ç—Ä–µ–±—É–µ—Ç—Å—è") -->
    <div id="editItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–¥–∞–Ω–∏–µ</h2><button class="modal-close" onclick="closeModal('editItemModal')">&times;</button></div>
            <input type="hidden" id="editItemId">
            <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="editItemName" class="form-control"></div>
            <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="editItemDesc" class="form-control"></div>
            <div class="form-group"><label>–¶–µ–Ω–∞</label><input type="number" id="editItemPrice" class="form-control"></div>
            <div class="form-group"><label>–ò–∫–æ–Ω–∫–∞</label><input type="text" id="editItemIcon" class="form-control"></div>
            <div class="form-group"><label>–¢–∏–ø</label><input type="text" id="editItemType" class="form-control"></div>
            <div class="form-group"><label>–≠–Ω–µ—Ä–≥–∏—è –¥–∞—ë—Ç</label><input type="number" id="editItemEnergyProvides" class="form-control"></div>
            <div class="form-group"><label>–≠–Ω–µ—Ä–≥–∏—è –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç</label><input type="number" id="editItemEnergyCost" class="form-control"></div>
            <div class="form-group"><label>–ö–æ–ª–æ–Ω–∏—Å—Ç—ã –¥–∞—ë—Ç</label><input type="number" id="editItemColonistsProvides" class="form-control"></div>
            <div class="form-group"><label>–ï–¥–∞ –¥–∞—ë—Ç</label><input type="number" id="editItemFoodProvides" class="form-control"></div>
            <div class="form-group"><label>–ë–æ–Ω—É—Å —Ç–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥–∞</label><input type="number" id="editItemTerraformBonus" class="form-control"></div>
            <div class="form-group"><label><input type="checkbox" id="editItemProduction"> –î–æ—Ö–æ–¥–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</label></div>
            <div class="form-group"><label><input type="checkbox" id="editItemUnique"> –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ</label></div>
            <div class="form-group"><label>–ú–∞–∫—Å –Ω–∞ –∫–æ–º–∞–Ω–¥—É</label><input type="number" id="editItemMaxPerTeam" class="form-control"></div>
            <div class="form-group"><label>–≠—Ñ—Ñ–µ–∫—Ç (JSON)</label><textarea id="editItemEffect" class="form-control" rows="3"></textarea></div>
            <div class="form-group"><label>–ü–µ—Ä—Å–æ–Ω–∞–ª —Ç—Ä–µ–±—É–µ—Ç—Å—è</label><input type="number" id="editItemStaffRequired" class="form-control"></div>
            <div style="display:flex; gap:10px;"><button onclick="updateItem()" class="btn btn-primary" style="flex:1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button onclick="deleteItem()" class="btn btn-danger" style="flex:1;">–£–¥–∞–ª–∏—Ç—å</button></div>
        </div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è -->
    <div id="addEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="eventModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</h2><button class="modal-close" onclick="closeModal('addEventModal')">&times;</button></div>
            <input type="hidden" id="editEventId">
            <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="eventName" class="form-control"></div>
            <div class="form-group"><label>–¢–∏–ø (positive/negative)</label>
                <select id="eventType" class="form-control">
                    <option value="positive">–ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ</option>
                    <option value="negative">–ù–µ–≥–∞—Ç–∏–≤–Ω–æ–µ</option>
                </select>
            </div>
            <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞</label><textarea id="eventDescription" class="form-control" rows="3"></textarea></div>
            <div class="form-group"><label>–≠—Ñ—Ñ–µ–∫—Ç (JSON)</label><textarea id="eventEffect" class="form-control" rows="5">{
  "type": "incomeBoost",
  "target": "–¥–æ–±—ã—á–∞",
  "value": 0.1
}</textarea></div>
            <button onclick="saveEvent()" class="btn btn-primary" style="width:100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∫–æ–º–∞–Ω–¥—ã (–¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞) -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="inventoryTeamName">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∫–æ–º–∞–Ω–¥—ã</h2><button class="modal-close" onclick="closeModal('inventoryModal')">&times;</button></div>
            <div id="inventoryList" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ -->
    <div id="confirmBuyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏</h2><button class="modal-close" onclick="closeModal('confirmBuyModal')">&times;</button></div>
            <div id="confirmBuyDetails"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="executeBuy()" class="btn btn-success" style="flex:1;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button onclick="closeModal('confirmBuyModal')" class="btn btn-danger" style="flex:1;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =================
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzJqpfgc4De_IZ8-0QVJArsbvNvAg01VNmPPVbZp_OqTZ4He85zn_zWVgSI_OYauFelnA/exec',
            ADMIN_PASSWORD: 'org2026',
            REFRESH_INTERVAL: 60000
        };

        // ================= –°–û–°–¢–û–Ø–ù–ò–ï =================
        let currentState = {
            team: null,
            isAdmin: false,
            adminPassword: '',
            allTeams: [],
            allItems: [],
            purchases: [],
            transactions: [],
            rating: [],
            contracts: [],
            events: [],
            gameState: { epoch: 0, name: '–ó–∞—Ä—è', startTime: null },
            finalScores: []
        };

        let pendingBuyItemId = null;
        let currentFilter = 'all';
        let isBuying = false;
        let timerInterval = null;

        // ================= –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò =================
        function showNotification(message, type = 'info') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type}`;
            notif.style.display = 'block';
            setTimeout(() => { notif.style.display = 'none'; }, 3000);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'confirmBuyModal') {
                isBuying = false; // —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –±–µ–∑ –ø–æ–∫—É–ø–∫–∏
            }
        }

        function logout() {
            currentState.team = null;
            currentState.isAdmin = false;
            currentState.adminPassword = '';
            localStorage.removeItem('team');
            localStorage.removeItem('admin');
            localStorage.removeItem('adminPwd');
            stopAutoRefresh();
            stopTimer();
            showScreen('loginScreen');
        }

        // ================= –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø =================
        document.addEventListener('DOMContentLoaded', () => {
            const savedTeam = localStorage.getItem('team');
            const savedAdmin = localStorage.getItem('admin') === 'true';
            const savedPwd = localStorage.getItem('adminPwd');
            if (savedTeam) {
                currentState.team = JSON.parse(savedTeam);
                showScreen('teamScreen');
                loadTeamData();
                startAutoRefresh();
            } else if (savedAdmin && savedPwd) {
                currentState.isAdmin = true;
                currentState.adminPassword = savedPwd;
                showScreen('adminScreen');
                loadAdminData();
                startAutoRefresh();
            }

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.type;
                    if (currentState.team) updateTeamUI();
                });
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ –ø–æ–∫—É–ø–∫–∏
            document.getElementById('confirmBuyModal').addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-close') || e.target === this) {
                    closeModal('confirmBuyModal');
                }
            });
        });

        function loginAsTeam() {
            const code = document.getElementById('teamCodeInput').value.trim().toUpperCase();
            if (!code) return showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥', 'error');
            fetch(`${CONFIG.SCRIPT_URL}?action=getTeamByCode&code=${encodeURIComponent(code)}`)
                .then(r => r.json())
                .then(res => {
                    if (res.success && res.data.team) {
                        currentState.team = res.data.team;
                        localStorage.setItem('team', JSON.stringify(currentState.team));
                        showScreen('teamScreen');
                        loadTeamData();
                        startAutoRefresh();
                        showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentState.team.name}!`, 'success');
                    } else {
                        showNotification('–ö–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    }
                })
                .catch(() => showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error'));
        }

        function loginAsAdmin() {
            const pwd = document.getElementById('adminPasswordInput').value;
            if (!pwd) return showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', 'error');
            fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ action: 'checkPassword', password: pwd })
            })
            .then(r => r.json())
            .then(res => {
                if (res.success && res.data.valid) {
                    currentState.isAdmin = true;
                    currentState.adminPassword = pwd;
                    localStorage.setItem('admin', 'true');
                    localStorage.setItem('adminPwd', pwd);
                    showScreen('adminScreen');
                    loadAdminData();
                    startAutoRefresh();
                    showNotification('–î–æ—Å—Ç—É–ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞', 'success');
                } else {
                    showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
                }
            })
            .catch(() => showNotification('–û—à–∏–±–∫–∞', 'error'));
        }

        // ================= –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ö–û–ú–ê–ù–î–´ =================
        async function loadTeamData() {
            if (!currentState.team) return;
            try {
                const [ratingRes, historyRes, itemsRes, invRes, contractsRes, eventsRes, stateRes] = await Promise.all([
                    fetch(`${CONFIG.SCRIPT_URL}?action=getRating`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getTransactions&teamId=${currentState.team.id}`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getShopItems`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getTeamInventory&teamId=${currentState.team.id}`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getContracts`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getEvents`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getGameState`)
                ]);

                const ratingData = await ratingRes.json();
                const historyData = await historyRes.json();
                const itemsData = await itemsRes.json();
                const invData = await invRes.json();
                const contractsData = await contractsRes.json();
                const eventsData = eventsRes.ok ? await eventsRes.json() : { success: false };
                const stateData = stateRes.ok ? await stateRes.json() : { data: { epoch: 0, name: '–ó–∞—Ä—è', startTime: null } };

                if (ratingData.success) {
                    currentState.rating = ratingData.data.rating || [];
                    const updated = currentState.rating.find(t => t.id == currentState.team.id);
                    if (updated) {
                        currentState.team = { ...currentState.team, ...updated };
                        localStorage.setItem('team', JSON.stringify(currentState.team));
                    }
                }
                if (historyData.success) currentState.transactions = historyData.data.transactions || [];
                if (itemsData.success) currentState.allItems = itemsData.data.items || [];
                if (invData.success) currentState.purchases = invData.data.items || [];
                if (contractsData.success) currentState.contracts = contractsData.data.contracts || [];
                if (eventsData.success) currentState.events = eventsData.data.events || [];
                if (stateData.success) currentState.gameState = stateData.data;

                updateTeamUI();
                startTimerIfNeeded();
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            }
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
        }

        function startTimerIfNeeded() {
            stopTimer();
            const epoch = currentState.gameState.epoch || 0;
            if (epoch === 0 || epoch === 7) return;
            const startTime = currentState.gameState.startTime;
            if (!startTime) return;

            const updateTimer = () => {
                const now = Date.now();
                const elapsed = Math.floor((now - startTime) / 1000);
                const remaining = 30 * 60 - elapsed;
                const timerEl = document.getElementById('timerDisplay');
                if (remaining <= 0) {
                    timerEl.textContent = '00:00';
                    stopTimer();
                    loadTeamData();
                } else {
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    const timeStr = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
                    timerEl.textContent = timeStr;
                    if (remaining < 300) timerEl.classList.add('warning');
                    else timerEl.classList.remove('warning');
                }
            };
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function getFoodEmoji(coverage) {
            if (coverage >= 1) return 'üòä';
            if (coverage >= 0.8) return 'üôÇ';
            if (coverage >= 0.6) return 'üòê';
            return 'üòü';
        }

        function showFinalMessage() {
            fetch(`${CONFIG.SCRIPT_URL}?action=getFinalScores`)
                .then(r => r.json())
                .then(res => {
                    if (!res.success) return;
                    const finalData = res.data.final;
                    const myTeam = finalData.find(t => t.id == currentState.team.id);
                    if (!myTeam) return;

                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'final-panel';
                    msgDiv.innerHTML = `
                        <div class="final-content">
                            <h1 class="final-title">üåå –ò—Ç–æ–≥–∏ –∫–æ–ª–æ–Ω–∏–∑–∞—Ü–∏–∏ üåå</h1>
                            <div class="final-stats">
                                <div class="final-stat">
                                    <span class="final-label">–ò–º–ø—É–ª—å—Å—ã</span>
                                    <span class="final-value">${myTeam.score}</span>
                                </div>
                                <div class="final-stat">
                                    <span class="final-label">–ò–Ω–¥–µ–∫—Å —Ç–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥–∞</span>
                                    <span class="final-value">${myTeam.terraformIndex}%</span>
                                </div>
                                <div class="final-stat">
                                    <span class="final-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫—Ä–∞—Å–æ—Ç—ã</span>
                                    <span class="final-value">${myTeam.beautyFactor}</span>
                                </div>
                                <div class="final-stat final-total">
                                    <span class="final-label">–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª</span>
                                    <span class="final-value">${myTeam.finalScore}</span>
                                </div>
                            </div>
                            <div class="final-place">
                                –í–∞—à–µ –º–µ—Å—Ç–æ: <strong>${finalData.findIndex(t => t.id == myTeam.id) + 1}</strong> –∏–∑ ${finalData.length}
                            </div>
                            <button class="btn btn-primary" onclick="location.reload()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                        </div>
                    `;
                    document.body.appendChild(msgDiv);
                });
        }

        function updateTeamUI() {
            if (!currentState.team) return;
            const epoch = currentState.gameState.epoch || 0;
            const epochName = currentState.gameState.name || '–ó–∞—Ä—è';
            document.getElementById('epochDisplay').innerHTML = `‚ö° ${epochName}`;

            if (epoch === 7) {
                showFinalMessage();
                return;
            }

            document.getElementById('teamNameHeader').textContent = currentState.team.name;
            document.getElementById('teamScoreHeader').textContent = currentState.team.score;
            document.getElementById('teamScoreBadge').textContent = currentState.team.score;

            const usedEnergy = currentState.purchases.filter(p => p.status === '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç').reduce((sum, p) => sum + (p.energyCost || 0), 0);

            const colonists = currentState.team.colonists || 0;
            const food = currentState.team.foodSupply || 0;
            const deficit = Math.max(0, colonists - food);
            const coverage = colonists > 0 ? Math.min(1, food / colonists) : 1;
            const coveragePercent = Math.round(coverage * 100);
            const foodEmoji = getFoodEmoji(coverage);

            // –†–∞—Å—á—ë—Ç —Ç—Ä–µ–±—É–µ–º–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ (staffRequired)
            let requiredStaff = 0;
            currentState.purchases.forEach(p => {
                if (p.status === '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç' && 
                    (p.type === '–¥–æ–±—ã—á–∞' || p.type === '–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ' || p.type === '–±—É—Å—Ç–µ—Ä' || p.type === '—ç–Ω–µ—Ä–≥–∏—è' || p.type === '–µ–¥–∞')) {
                    requiredStaff += p.staffRequired || 0;
                }
            });
            const staffDeficit = requiredStaff - colonists;
            const staffRatio = requiredStaff === 0 ? 1 : Math.min(1, colonists / requiredStaff);

            const dashboardStats = document.getElementById('dashboardStats');
            dashboardStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-header"><div class="stat-icon"><i class="fas fa-bolt"></i></div></div>
                        <div class="stat-value">${currentState.team.score}</div>
                        <div class="stat-label">–ú–æ–∏ –∏–º–ø—É–ª—å—Å—ã</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-header"><div class="stat-icon"><i class="fas fa-users"></i></div></div>
                        <div class="stat-value">${currentState.rating.length}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∫–æ–º–∞–Ω–¥</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content ${epoch === 0 ? 'blurred' : ''}">
                        <div class="stat-header"><div class="stat-icon"><i class="fas fa-leaf"></i></div></div>
                        <div class="stat-value">${currentState.team.terraformIndex || 50}%</div>
                        <div class="stat-label">–¢–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥</div>
                    </div>
                    <div class="lock-overlay" style="display: ${epoch === 0 ? 'flex' : 'none'};"><i class="fas fa-lock"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-content ${epoch === 0 ? 'blurred' : ''}">
                        <div class="stat-header"><div class="stat-icon"><i class="fas fa-bolt"></i></div></div>
                        <div class="stat-value">${usedEnergy} / ${currentState.team.energySlots || 0}</div>
                        <div class="stat-label">–≠–Ω–µ—Ä–≥–∏—è (—Å–ª–æ—Ç—ã)</div>
                    </div>
                    <div class="lock-overlay" style="display: ${epoch === 0 ? 'flex' : 'none'};"><i class="fas fa-lock"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-content ${epoch === 0 ? 'blurred' : ''}">
                        <div class="stat-header"><div class="stat-icon"><i class="fas fa-user"></i></div></div>
                        <div class="stat-value">${colonists}</div>
                        <div class="stat-label">–ö–æ–ª–æ–Ω–∏—Å—Ç—ã</div>
                    </div>
                    <div class="lock-overlay" style="display: ${epoch === 0 ? 'flex' : 'none'};"><i class="fas fa-lock"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-content ${epoch === 0 ? 'blurred' : ''}">
                        <div style="display: flex; align-items: center; justify-content: center; font-size: 64px;">
                            ${foodEmoji}
                        </div>
                        <div class="stat-label">–ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="lock-overlay" style="display: ${epoch === 0 ? 'flex' : 'none'};"><i class="fas fa-lock"></i></div>
                </div>
            `;

            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –µ–¥–µ
            if (coveragePercent < 80) {
                document.getElementById('foodWarningText').innerHTML = 
                    `–ö–æ–ª–æ–Ω–∏—Å—Ç—ã –≥–æ–ª–æ–¥–∞—é—Ç. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é —Å–∏–Ω—Ç–µ–∑–∞ –ø–∏—â–µ–≤—ã—Ö –Ω–∞–±–æ—Ä–æ–≤, —á—Ç–æ–±—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç–∞–ª–∏ –Ω–∞ –ø–æ–ª–Ω—É—é –º–æ—â–Ω–æ—Å—Ç—å. <br>
                     –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ${deficit} –µ–¥—ã. –ü–æ–∫—Ä—ã—Ç–∏–µ –µ–¥–æ–π: ${coveragePercent}%.`;
                document.getElementById('foodWarning').style.display = 'block';
            } else {
                document.getElementById('foodWarning').style.display = 'none';
            }

            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–µ—Ä—Å–æ–Ω–∞–ª–µ
            if (staffDeficit > 0) {
                document.getElementById('staffWarningText').innerHTML = 
                    `–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ${staffDeficit} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤ —Å–Ω–∏–∂–µ–Ω–∞ –¥–æ ${Math.round(staffRatio * 100)}%.`;
                document.getElementById('staffWarning').style.display = 'block';
            } else {
                document.getElementById('staffWarning').style.display = 'none';
            }

            // –°–æ–±—ã—Ç–∏–µ
            if (currentState.team.currentEvent) {
                document.getElementById('eventText').textContent = currentState.team.currentEvent;
                document.getElementById('currentEvent').style.display = 'block';
            } else {
                document.getElementById('currentEvent').style.display = 'none';
            }

            // –ö–æ–Ω—Ç—Ä–∞–∫—Ç (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞)
            if (epoch > 0) {
                document.getElementById('contractContainer').style.display = 'block';
                let contractHtml = '';
                if (currentState.team.contractId) {
                    const contract = currentState.contracts.find(c => c.id == currentState.team.contractId);
                    if (contract) {
                        contractHtml = `<p>${contract.desc}</p><p>–ù–∞–≥—Ä–∞–¥–∞: ${contract.reward} ‚ö°</p>`;
                        if (currentState.team.contractDone) contractHtml += '<p style="color:var(--neon-green)">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω</p>';
                    } else {
                        contractHtml = '<p>–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>';
                    }
                } else {
                    contractHtml = '<p>–£ –∫–æ–º–∞–Ω–¥—ã –ø–æ–∫–∞ –Ω–µ—Ç —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞.</p>';
                }
                document.getElementById('contractInfo').innerHTML = contractHtml;
            } else {
                document.getElementById('contractContainer').style.display = 'none';
            }

            // –ò—Å—Ç–æ—Ä–∏—è
            let histHtml = '<table><tr><th>–í—Ä–µ–º—è</th><th>–ò–º–ø—É–ª—å—Å—ã</th><th>–ü—Ä–∏—á–∏–Ω–∞</th></tr>';
            if (currentState.transactions.length) {
                currentState.transactions.slice(0,10).forEach(t => {
                    histHtml += `<tr><td>${new Date(t.timestamp).toLocaleString()}</td><td>${t.points>0?'+':''}${t.points}</td><td>${t.reason}</td></tr>`;
                });
            } else histHtml += '<tr><td colspan="3">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏</td></tr>';
            histHtml += '</table>';
            document.getElementById('historyTable').innerHTML = histHtml;

            // –†–µ–π—Ç–∏–Ω–≥
            const hasRevealRating = currentState.purchases.some(p => p.status === '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç' && p.effect && p.effect.revealRating);
            const ratingContainer = document.getElementById('ratingContainer');
            if (hasRevealRating) {
                ratingContainer.style.display = 'block';
                const sorted = [...currentState.rating].sort((a, b) => b.score - a.score);
                let rateHtml = '<table><tr><th>–ú–µ—Å—Ç–æ</th><th>–ö–æ–º–∞–Ω–¥–∞</th><th>–ò–º–ø—É–ª—å—Å—ã</th></tr>';
                sorted.forEach((t, i) => {
                    rateHtml += `<tr ${t.id == currentState.team.id ? 'style="background:rgba(78,84,245,0.3)"' : ''}><td>${i+1}</td><td>${t.name}</td><td>${t.score}</td></tr>`;
                });
                rateHtml += '</table>';
                document.getElementById('ratingTable').innerHTML = rateHtml;
            } else {
                ratingContainer.style.display = 'none';
            }

            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–∫–ª–∞–¥–æ–∫ –¥–æ —Å—Ç–∞—Ä—Ç–∞
            const tabBtns = document.querySelectorAll('#teamScreen .tab-btn');
            tabBtns.forEach((btn, idx) => {
                if (idx === 0) return;
                if (epoch === 0) {
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.3';
                } else {
                    btn.style.pointerEvents = 'auto';
                    btn.style.opacity = '1';
                }
            });

            if (epoch === 0) {
                document.getElementById('teamShopTab').innerHTML = '<div class="table-container"><p style="text-align:center;">–ú–∞–≥–∞–∑–∏–Ω –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ —ç–ø–æ—Ö–∏</p></div>';
                document.getElementById('teamInventoryTab').innerHTML = '<div class="table-container"><p style="text-align:center;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ —ç–ø–æ—Ö–∏</p></div>';
                document.getElementById('teamFinanceTab').innerHTML = '<div class="table-container"><p style="text-align:center;">–§–∏–Ω–∞–Ω—Å—ã –æ—Ç–∫—Ä–æ—é—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ —ç–ø–æ—Ö–∏</p></div>';
            } else {
                updateShopAndInventory(epoch);
            }
        }

        function updateShopAndInventory(epoch) {
            if (epoch === 0) return;

            // –ú–∞–≥–∞–∑–∏–Ω
            document.getElementById('shopImpulseBalance').textContent = currentState.team.score;
            let shopHtml = '';
            if (currentState.allItems.length) {
                const functionalIds = currentState.purchases.filter(p => p.status === '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç').map(p => p.id);
                function isItemAvailable(item) {
                    const id = item.id;
                    if (id <= 5) return true;
                    if (id >= 6 && id <= 9) return functionalIds.some(fid => fid <= 5);
                    if (id >= 10 && id <= 13) return functionalIds.some(fid => fid >= 6 && fid <= 9);
                    if (id >= 14 && id <= 17) return functionalIds.some(fid => fid >= 10 && fid <= 13);
                    if (id >= 18 && id <= 21) return functionalIds.some(fid => fid >= 14 && fid <= 17);
                    if (id >= 22 && id <= 27) return functionalIds.some(fid => fid >= 18 && fid <= 21);
                    if (id >= 28 && id <= 33) return functionalIds.some(fid => fid >= 22 && fid <= 27);
                    return functionalIds.some(fid => fid >= 28 && fid <= 33);
                }

                function getRequirementText(item) {
                    const id = item.id;
                    if (id <= 5) return '–î–æ—Å—Ç—É–ø–Ω–æ';
                    if (id <= 9) return '–¢—Ä–µ–±—É–µ—Ç—Å—è –ª—é–±–æ–µ –∑–¥–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞ 1';
                    if (id <= 13) return '–¢—Ä–µ–±—É–µ—Ç—Å—è –ª—é–±–æ–µ –∑–¥–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞ 2';
                    if (id <= 17) return '–¢—Ä–µ–±—É–µ—Ç—Å—è –ª—é–±–æ–µ –∑–¥–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞ 3';
                    if (id <= 21) return '–¢—Ä–µ–±—É–µ—Ç—Å—è –ª—é–±–æ–µ –∑–¥–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞ 4';
                    if (id <= 27) return '–¢—Ä–µ–±—É–µ—Ç—Å—è –ª—é–±–æ–µ –∑–¥–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞ 5';
                    return '–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–¥–∞–Ω–∏–µ 6 —Å–µ–∑–æ–Ω–∞';
                }

                const itemsByType = {};
                currentState.allItems.forEach(item => {
                    const type = item.type || '–¥—Ä—É–≥–æ–µ';
                    if (!itemsByType[type]) itemsByType[type] = [];
                    itemsByType[type].push(item);
                });

                const sortedTypes = Object.keys(itemsByType).sort();
                const purchasedIds = currentState.purchases.map(p => p.id);
                const hasBoughtStatus = currentState.purchases.some(p => p.status === '–∫—É–ø–ª–µ–Ω–æ');

                for (let type of sortedTypes) {
                    if (currentFilter !== 'all' && currentFilter !== type) continue;
                    shopHtml += `<div class="category-header">${type.charAt(0).toUpperCase() + type.slice(1)}</div>`;
                    itemsByType[type].forEach(item => {
                        const purchase = currentState.purchases.find(p => p.id === item.id);
                        const status = purchase ? purchase.status : null;
                        const isBought = !!purchase;
                        const isAwaiting = status === '–∫—É–ø–ª–µ–Ω–æ';
                        const available = isItemAvailable(item);
                        const disabled = isBought || currentState.team.score < item.price || hasBoughtStatus || !available;
                        let buttonText = '–ö—É–ø–∏—Ç—å';
                        if (isBought) {
                            buttonText = isAwaiting ? '–û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏' : '–£–∂–µ –∫—É–ø–ª–µ–Ω–æ';
                        } else if (!available) {
                            buttonText = getRequirementText(item);
                        }
                        const cardClass = isAwaiting ? 'product-card pulse-awaiting' : 'product-card';
                        let detailsHtml = '';
                        if (item.energyProvides) detailsHtml += `<div><i class="fas fa-bolt"></i> –î–∞—ë—Ç —ç–Ω–µ—Ä–≥–∏–∏: ${item.energyProvides}</div>`;
                        if (item.energyCost) detailsHtml += `<div><i class="fas fa-plug"></i> –ü–æ—Ç—Ä–µ–±–ª—è–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏: ${item.energyCost}</div>`;
                        if (item.colonistsProvides) detailsHtml += `<div><i class="fas fa-users"></i> +${item.colonistsProvides} –∫–æ–ª–æ–Ω–∏—Å—Ç–æ–≤</div>`;
                        if (item.foodProvides) detailsHtml += `<div><i class="fas fa-utensils"></i> +${item.foodProvides} –µ–¥—ã/—Å–µ–∑–æ–Ω</div>`;
                        if (item.terraformBonus) detailsHtml += `<div><i class="fas fa-leaf"></i> –¢–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥: ${item.terraformBonus > 0 ? '+' : ''}${item.terraformBonus}%</div>`;
                        if (item.effect && item.effect.income) detailsHtml += `<div><i class="fas fa-coins"></i> –î–æ—Ö–æ–¥: ${item.effect.income} ‚ö°/—Å–µ–∑–æ–Ω</div>`;
                        if (item.effect && item.effect.boostType) detailsHtml += `<div><i class="fas fa-rocket"></i> –ë—É—Å—Ç–µ—Ä: +${item.effect.value*100}% –∫ ${item.effect.boostType}</div>`;
                        if (item.staffRequired) detailsHtml += `<div><i class="fas fa-users"></i> –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä—Å–æ–Ω–∞–ª: ${item.staffRequired}</div>`;

                        shopHtml += `
                            <div class="${cardClass}">
                                <div class="product-icon"><i class="${item.icon}"></i></div>
                                <div class="product-name">${item.name}</div>
                                <div class="product-description">${item.description}</div>
                                <div class="product-details">${detailsHtml}</div>
                                <div class="product-price"><i class="fas fa-bolt"></i> ${item.price}</div>
                                <button class="btn-buy" onclick="confirmBuy(${item.id})" ${disabled ? 'disabled' : ''}>
                                    ${buttonText}
                                </button>
                            </div>
                        `;
                    });
                }
            } else {
                shopHtml = '<p>–¢–æ–≤–∞—Ä—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>';
            }
            document.getElementById('shopItemsGrid').innerHTML = shopHtml;

            // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
            let invHtml = '';
            if (currentState.purchases.length) {
                currentState.purchases.forEach(item => {
                    const extraButton = item.status === '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç' ? getExtraButton(item) : '';
                    invHtml += `
                        <div class="product-card">
                            <div class="product-icon"><i class="${item.icon}"></i></div>
                            <div class="product-name">${item.name}</div>
                            <div class="product-description">${item.description}</div>
                            <div><span class="status-badge ${item.status}">${item.status}</span></div>
                            <div style="margin-top:10px;">${extraButton}</div>
                        </div>
                    `;
                });
            } else invHtml = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –∑–¥–∞–Ω–∏–π.</p>';
            document.getElementById('inventoryGrid').innerHTML = invHtml;

            // –§–∏–Ω–∞–Ω—Å—ã
            document.getElementById('investmentsValue').textContent = currentState.team.investments || 0;
            document.getElementById('loanValue').textContent = currentState.team.loan || 0;

            const hasLoanBuilding = currentState.purchases.some(p => p.status === '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç' && p.effect && p.effect.loan);
            const hasInvestBuilding = currentState.purchases.some(p => p.status === '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç' && p.effect && p.effect.fund);
            const hasTotem = currentState.purchases.some(p => p.status === '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç' && p.type === '—Ç–æ—Ç–µ–º');

            let financeActionsHtml = '';
            if (hasInvestBuilding) {
                financeActionsHtml += `<button onclick="investInFund()" class="btn btn-success" style="margin-right:10px;">üìà –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ñ–æ–Ω–¥</button>`;
            }
            if (hasLoanBuilding) {
                financeActionsHtml += `<button onclick="takeLoan()" class="btn btn-warning" style="margin-right:10px;">üí∞ –í–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç</button>`;
            }
            if (hasLoanBuilding && currentState.team.loan > 0) {
                financeActionsHtml += `<button onclick="repayLoan()" class="btn btn-danger">üí∏ –ü–æ–≥–∞—Å–∏—Ç—å –∫—Ä–µ–¥–∏—Ç (150%)</button>`;
            }
            if (financeActionsHtml === '') {
                financeActionsHtml = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –±–∞–Ω–∫ –∏–ª–∏ —Ñ–æ–Ω–¥.</p>';
            }
            document.getElementById('financeActions').innerHTML = financeActionsHtml;

            if (hasTotem) {
                document.getElementById('totemSection').style.display = 'block';
                document.getElementById('totemInvested').textContent = currentState.team.totemInvested || 0;
            } else {
                document.getElementById('totemSection').style.display = 'none';
            }
        }

        function getExtraButton(item) {
            if (item.effect && item.effect.gamble) {
                return `<button class="btn btn-warning btn-sm" onclick="activateVenture(${item.purchaseId})">üé≤ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—Ç–∞–ø</button>`;
            }
            if (item.effect && item.effect.ability === 'recreation') {
                return `<button class="btn btn-info btn-sm" onclick="activateRecreation(${item.purchaseId})">üèùÔ∏è –û—Ç–¥—ã—Ö</button>`;
            }
            if (item.effect && item.effect.ability === 'recompute') {
                return `<button class="btn btn-primary btn-sm" onclick="activateQuantum(${item.purchaseId})">‚öõÔ∏è –ö–≤–∞–Ω—Ç–æ–≤—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç</button>`;
            }
            return '';
        }

        function confirmBuy(itemId) {
            if (isBuying) {
                showNotification('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –ø–æ–∫—É–ø–∫–∏', 'warning');
                return;
            }
            const item = currentState.allItems.find(i => i.id === itemId);
            if (!item) return;
            pendingBuyItemId = itemId;
            document.getElementById('confirmBuyDetails').innerHTML = `
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å <strong>${item.name}</strong> –∑–∞ ${item.price} ‚ö°?</p>
                <p>${item.description}</p>
            `;
            document.getElementById('confirmBuyModal').classList.add('active');
        }

        async function executeBuy() {
            if (isBuying) return;
            isBuying = true;
            const confirmBtn = document.querySelector('#confirmBuyModal .btn-success');
            const originalText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.textContent = '–ü–æ–∫—É–ø–∫–∞...';
            try {
                await buyItem(pendingBuyItemId);
            } finally {
                isBuying = false;
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
            closeModal('confirmBuyModal');
            pendingBuyItemId = null;
        }

        async function buyItem(itemId) {
            if (!currentState.team) return;
            try {
                const formData = new FormData();
                formData.append('action', 'buyItem');
                formData.append('teamId', currentState.team.id);
                formData.append('itemId', itemId);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–ó–¥–∞–Ω–∏–µ –∫—É–ø–ª–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –ø–æ–¥–æ–π–¥–∏—Ç–µ –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É –∑–∞ –º–∞–∫–µ—Ç–æ–º.', 'success');
                    currentState.team.score = result.data.newScore;
                    const newPurchase = {
                        id: itemId,
                        purchaseId: result.data.purchaseId,
                        status: '–∫—É–ø–ª–µ–Ω–æ',
                        name: result.data.item.name,
                        description: currentState.allItems.find(i => i.id === itemId).description,
                        icon: currentState.allItems.find(i => i.id === itemId).icon
                    };
                    currentState.purchases.push(newPurchase);
                    localStorage.setItem('team', JSON.stringify(currentState.team));
                    updateTeamUI();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function activateVenture(purchaseId) {
            if (!confirm('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–µ–Ω—á—É—Ä–Ω—ã–π —Å—Ç–∞—Ä—Ç–∞–ø? –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª—É—á–∞–µ–Ω.')) return;
            try {
                const formData = new FormData();
                formData.append('action', 'activateVenture');
                formData.append('teamId', currentState.team.id);
                formData.append('purchaseId', purchaseId);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification(`–°—Ç–∞—Ä—Ç–∞–ø –ø—Ä–∏–Ω—ë—Å ${result.data.gain} ‚ö°`, 'success');
                    loadTeamData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function activateRecreation(purchaseId) {
            if (!confirm('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫—Ä–µ–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å? –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω –±–æ–Ω—É—Å –∑–∞ –∂–∏–ª—ã–µ –∑–¥–∞–Ω–∏—è.')) return;
            try {
                const formData = new FormData();
                formData.append('action', 'activateRecreation');
                formData.append('teamId', currentState.team.id);
                formData.append('purchaseId', purchaseId);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification(`–ë–æ–Ω—É—Å: ${result.data.bonus} ‚ö°`, 'success');
                    loadTeamData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function activateQuantum(purchaseId) {
            showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        async function investInFund() {
            const amount = prompt('–°—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ (–º–∏–Ω–∏–º—É–º 5):', '5');
            if (!amount) return;
            const num = parseInt(amount);
            if (num < 5) return showNotification('–ú–∏–Ω–∏–º—É–º 5', 'warning');
            try {
                const formData = new FormData();
                formData.append('action', 'investInFund');
                formData.append('teamId', currentState.team.id);
                formData.append('amount', num);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification(`–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ ${num} ‚ö°`, 'success');
                    loadTeamData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function takeLoan() {
            const amount = prompt('–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ (1-10):', '5');
            if (!amount) return;
            const num = parseInt(amount);
            if (num < 1 || num > 10) return showNotification('–û—Ç 1 –¥–æ 10', 'warning');
            try {
                const formData = new FormData();
                formData.append('action', 'takeLoan');
                formData.append('teamId', currentState.team.id);
                formData.append('amount', num);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification(`–ö—Ä–µ–¥–∏—Ç ${num} –ø–æ–ª—É—á–µ–Ω`, 'success');
                    loadTeamData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function repayLoan() {
            if (!confirm('–ü–æ–≥–∞—Å–∏—Ç—å –∫—Ä–µ–¥–∏—Ç —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º 1.5?')) return;
            try {
                const formData = new FormData();
                formData.append('action', 'repayLoan');
                formData.append('teamId', currentState.team.id);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–ö—Ä–µ–¥–∏—Ç –ø–æ–≥–∞—à–µ–Ω', 'success');
                    loadTeamData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function totemContribute() {
            const amount = prompt('–°–∫–æ–ª—å–∫–æ –∏–º–ø—É–ª—å—Å–æ–≤ –≤–Ω–µ—Å—Ç–∏ –≤ —Ç–æ—Ç–µ–º?', '10');
            if (!amount) return;
            const num = parseInt(amount);
            if (num <= 0) return showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ', 'warning');
            try {
                const formData = new FormData();
                formData.append('action', 'totemContribute');
                formData.append('teamId', currentState.team.id);
                formData.append('amount', num);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification(`–°–ø–∏—Å–∞–Ω–æ ${result.data.deducted} ‚ö° (–Ω–æ–º–∏–Ω–∞–ª ${num})`, 'info');
                    loadTeamData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function checkContract() {
            try {
                const formData = new FormData();
                formData.append('action', 'checkContract');
                formData.append('teamId', currentState.team.id);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification(`–ö–æ–Ω—Ç—Ä–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! –ü–æ–ª—É—á–µ–Ω–æ ${result.data.reward} ‚ö°`, 'success');
                    loadTeamData();
                } else {
                    showNotification(result.data.message || '–ö–æ–Ω—Ç—Ä–∞–∫—Ç –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'info');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        window.switchTeamTab = (tab) => {
            document.querySelectorAll('#teamScreen .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('teamDashboardTab').style.display = tab === 'dashboard' ? 'block' : 'none';
            document.getElementById('teamShopTab').style.display = tab === 'shop' ? 'block' : 'none';
            document.getElementById('teamInventoryTab').style.display = tab === 'inventory' ? 'block' : 'none';
            document.getElementById('teamFinanceTab').style.display = tab === 'finance' ? 'block' : 'none';
            if (tab !== 'dashboard') loadTeamData();
        };

        async function loadAdminData() {
            try {
                const [teamsRes, itemsRes, transRes, eventsRes, stateRes, finalRes] = await Promise.all([
                    fetch(`${CONFIG.SCRIPT_URL}?action=getTeams`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getShopItems`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getTransactions`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getEvents`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getGameState`),
                    fetch(`${CONFIG.SCRIPT_URL}?action=getFinalScores`)
                ]);
                const teamsData = await teamsRes.json();
                const itemsData = await itemsRes.json();
                const transData = await transRes.json();
                const eventsData = eventsRes.ok ? await eventsRes.json() : { success: false };
                const stateData = stateRes.ok ? await stateRes.json() : { data: { epoch: 0 } };
                const finalData = finalRes.ok ? await finalRes.json() : { success: false };

                if (teamsData.success) currentState.allTeams = teamsData.data.teams || [];
                if (itemsData.success) currentState.allItems = itemsData.data.items || [];
                if (transData.success) currentState.transactions = transData.data.transactions || [];
                if (eventsData.success) currentState.events = eventsData.data.events || [];
                if (stateData.success) currentState.gameState = stateData.data;
                if (finalData.success) currentState.finalScores = finalData.data.final || [];

                updateAdminUI();
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            }
        }

        function updateAdminUI() {
            let teamsHtml = '';
            if (currentState.allTeams.length) {
                currentState.allTeams.forEach(t => {
                    teamsHtml += `<tr>
                        <td>${t.id}</td>
                        <td>${t.name}</td>
                        <td>${t.score}</td>
                        <td>${t.purchasedCount || 0}</td>
                        <td>${t.totalSpent || 0}</td>
                        <td>${t.code}</td>
                        <td>${t.contact || '-'}</td>
                        <td>
                            <button class="btn btn-primary btn-icon" onclick="openEditTeamModal(${t.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-info btn-icon" onclick="showTeamInventory(${t.id})" title="–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å"><i class="fas fa-box"></i></button>
                        </td>
                    </tr>`;
                });
            } else teamsHtml = '<tr><td colspan="8">–ù–µ—Ç –∫–æ–º–∞–Ω–¥</td></tr>';
            document.getElementById('teamsTableBody').innerHTML = teamsHtml;

            let options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
            currentState.allTeams.forEach(t => options += `<option value="${t.id}">${t.name} (${t.score} ‚ö°)</option>`);
            document.getElementById('quickTeamSelect').innerHTML = options;
            document.getElementById('manualTeamSelect').innerHTML = options;
            document.getElementById('teamContractSelect').innerHTML = options;

            let itemsHtml = '';
            if (currentState.allItems.length) {
                currentState.allItems.forEach(i => {
                    itemsHtml += `<tr>
                        <td>${i.id}</td>
                        <td><i class="${i.icon}"></i></td>
                        <td>${i.name}</td>
                        <td>${i.price}</td>
                        <td>${i.type}</td>
                        <td>${i.unique ? '–î–∞' : '–ù–µ—Ç'}</td>
                        <td>
                            <button class="btn btn-primary btn-icon" onclick="openEditItemModal(${i.id})"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>`;
                });
            } else itemsHtml = '<tr><td colspan="7">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</td></tr>';
            document.getElementById('itemsTableBody').innerHTML = itemsHtml;

            let eventsHtml = '';
            if (currentState.events.length) {
                currentState.events.forEach(e => {
                    eventsHtml += `<tr>
                        <td>${e.type}</td>
                        <td>${e.name}</td>
                        <td>${e.description || ''}</td>
                        <td>
                            <button class="btn btn-primary btn-icon" onclick="openEditEventModal(${e.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-icon" onclick="deleteEvent(${e.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            } else eventsHtml = '<tr><td colspan="4">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</td></tr>';
            document.getElementById('eventsTableBody').innerHTML = eventsHtml;

            let finalHtml = '';
            if (currentState.finalScores.length) {
                currentState.finalScores.forEach((t, i) => {
                    finalHtml += `<tr>
                        <td>${i+1}</td>
                        <td>${t.name}</td>
                        <td>${t.score}</td>
                        <td>${t.terraformIndex}%</td>
                        <td><input type="number" step="0.1" min="0.5" max="1.5" value="${t.beautyFactor}" onchange="setBeautyFactor(${t.id}, this.value)" style="width:70px;"></td>
                        <td>${t.finalScore}</td>
                        <td><button onclick="setBeautyFactor(${t.id}, prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫—Ä–∞—Å–æ—Ç—ã (0.5-1.5)', ${t.beautyFactor}))" class="btn btn-primary btn-icon">‚úèÔ∏è</button></td>
                    </tr>`;
                });
            } else {
                finalHtml = '<tr><td colspan="7">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            }
            document.getElementById('finalScoresBody').innerHTML = finalHtml;

            document.getElementById('totalTeamsStat').textContent = currentState.allTeams.length;
            const totalImp = currentState.allTeams.reduce((acc, t) => acc + (t.score || 0), 0);
            document.getElementById('totalImpulsesStat').textContent = totalImp;
            const totalPurchases = currentState.allTeams.reduce((acc, t) => acc + (t.purchasedCount || 0), 0);
            document.getElementById('totalPurchasesStat').textContent = totalPurchases;

            let transHtml = '<table><tr><th>–í—Ä–µ–º—è</th><th>–ö–æ–º–∞–Ω–¥–∞</th><th>–ò–º–ø—É–ª—å—Å—ã</th><th>–ü—Ä–∏—á–∏–Ω–∞</th></tr>';
            if (currentState.transactions.length) {
                currentState.transactions.slice(0,10).forEach(t => {
                    const team = currentState.allTeams.find(tt => tt.id == t.teamId);
                    transHtml += `<tr><td>${new Date(t.timestamp).toLocaleString()}</td><td>${team ? team.name : t.teamId}</td><td>${t.points}</td><td>${t.reason}</td></tr>`;
                });
            } else transHtml += '<tr><td colspan="4">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</td></tr>';
            transHtml += '</table>';
            document.getElementById('recentTransactionsAdmin').innerHTML = transHtml;
        }

        function quickAdd(points, reason) {
            const teamId = document.getElementById('quickTeamSelect').value;
            if (!teamId) return showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É', 'warning');
            document.getElementById('manualTeamSelect').value = teamId;
            document.getElementById('pointsInput').value = points;
            document.getElementById('reasonInput').value = reason;
            manualAddPoints();
        }

        async function manualAddPoints() {
            const teamId = document.getElementById('manualTeamSelect').value;
            const points = parseInt(document.getElementById('pointsInput').value);
            const reason = document.getElementById('reasonInput').value.trim();
            if (!teamId || isNaN(points) || !reason) return showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');

            const formData = new FormData();
            formData.append('action', 'addPoints');
            formData.append('teamId', teamId);
            formData.append('points', points);
            formData.append('reason', reason);
            formData.append('moderator', '–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä');
            formData.append('password', currentState.adminPassword);

            try {
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–ù–∞—á–∏—Å–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
                    document.getElementById('pointsInput').value = '';
                    document.getElementById('reasonInput').value = '';
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        function showAddTeamModal() { document.getElementById('addTeamModal').classList.add('active'); }
        async function addTeam() {
            const name = document.getElementById('newTeamName').value.trim();
            const code = document.getElementById('newTeamCode').value.trim().toUpperCase();
            const contact = document.getElementById('newTeamContact').value.trim();
            if (!name || !code) return showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥', 'error');
            if (code.length !== 6) return showNotification('–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
            const formData = new FormData();
            formData.append('action', 'addTeam');
            formData.append('name', name);
            formData.append('code', code);
            formData.append('contact', contact);
            formData.append('password', currentState.adminPassword);
            try {
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–ö–æ–º–∞–Ω–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                    closeModal('addTeamModal');
                    document.getElementById('newTeamName').value = '';
                    document.getElementById('newTeamCode').value = '';
                    document.getElementById('newTeamContact').value = '';
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞', 'error'); }
        }

        function openEditTeamModal(id) {
            const team = currentState.allTeams.find(t => t.id == id);
            if (team) {
                document.getElementById('editTeamId').value = team.id;
                document.getElementById('editTeamName').value = team.name;
                document.getElementById('editTeamCode').value = team.code;
                document.getElementById('editTeamContact').value = team.contact || '';
                document.getElementById('editTeamModal').classList.add('active');
            }
        }
        async function updateTeam() {
            const id = document.getElementById('editTeamId').value;
            const name = document.getElementById('editTeamName').value.trim();
            const code = document.getElementById('editTeamCode').value.trim().toUpperCase();
            const contact = document.getElementById('editTeamContact').value.trim();
            if (!name || !code) return showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è', 'error');
            const formData = new FormData();
            formData.append('action', 'updateTeam');
            formData.append('teamId', id);
            formData.append('name', name);
            formData.append('code', code);
            formData.append('contact', contact);
            formData.append('password', currentState.adminPassword);
            try {
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                    closeModal('editTeamModal');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞', 'error'); }
        }
        async function deleteTeam() {
            const id = document.getElementById('editTeamId').value;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É?')) return;
            const formData = new FormData();
            formData.append('action', 'deleteTeam');
            formData.append('teamId', id);
            formData.append('password', currentState.adminPassword);
            try {
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–ö–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                    closeModal('editTeamModal');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞', 'error'); }
        }

        function showAddItemModal() { document.getElementById('addItemModal').classList.add('active'); }
        async function addItem() {
            const name = document.getElementById('newItemName').value.trim();
            const desc = document.getElementById('newItemDesc').value.trim();
            const price = parseInt(document.getElementById('newItemPrice').value);
            const icon = document.getElementById('newItemIcon').value.trim();
            const type = document.getElementById('newItemType').value.trim();
            const energyProvides = parseInt(document.getElementById('newItemEnergyProvides').value);
            const energyCost = parseInt(document.getElementById('newItemEnergyCost').value);
            const colonistsProvides = parseInt(document.getElementById('newItemColonistsProvides').value);
            const foodProvides = parseInt(document.getElementById('newItemFoodProvides').value);
            const terraformBonus = parseInt(document.getElementById('newItemTerraformBonus').value);
            const production = document.getElementById('newItemProduction').checked;
            const unique = document.getElementById('newItemUnique').checked;
            const maxPerTeam = parseInt(document.getElementById('newItemMaxPerTeam').value);
            const effect = document.getElementById('newItemEffect').value;
            const staffRequired = parseInt(document.getElementById('newItemStaffRequired').value) || 0;

            if (!name || !price) return showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É', 'error');
            try { JSON.parse(effect); } catch { return showNotification('–≠—Ñ—Ñ–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º JSON', 'error'); }

            const formData = new FormData();
            formData.append('action', 'addItem');
            formData.append('name', name);
            formData.append('description', desc);
            formData.append('price', price);
            formData.append('icon', icon);
            formData.append('type', type);
            formData.append('energyProvides', energyProvides);
            formData.append('energyCost', energyCost);
            formData.append('colonistsProvides', colonistsProvides);
            formData.append('foodProvides', foodProvides);
            formData.append('terraformBonus', terraformBonus);
            formData.append('production', production);
            formData.append('unique', unique);
            formData.append('maxPerTeam', maxPerTeam);
            formData.append('effect', effect);
            formData.append('staffRequired', staffRequired);
            formData.append('password', currentState.adminPassword);

            try {
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                    closeModal('addItemModal');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞', 'error'); }
        }

        function openEditItemModal(id) {
            const item = currentState.allItems.find(i => i.id == id);
            if (item) {
                document.getElementById('editItemId').value = item.id;
                document.getElementById('editItemName').value = item.name;
                document.getElementById('editItemDesc').value = item.description;
                document.getElementById('editItemPrice').value = item.price;
                document.getElementById('editItemIcon').value = item.icon;
                document.getElementById('editItemType').value = item.type;
                document.getElementById('editItemEnergyProvides').value = item.energyProvides || 0;
                document.getElementById('editItemEnergyCost').value = item.energyCost || 0;
                document.getElementById('editItemColonistsProvides').value = item.colonistsProvides || 0;
                document.getElementById('editItemFoodProvides').value = item.foodProvides || 0;
                document.getElementById('editItemTerraformBonus').value = item.terraformBonus || 0;
                document.getElementById('editItemProduction').checked = item.production || false;
                document.getElementById('editItemUnique').checked = item.unique || false;
                document.getElementById('editItemMaxPerTeam').value = item.maxPerTeam || 0;
                document.getElementById('editItemEffect').value = JSON.stringify(item.effect);
                document.getElementById('editItemStaffRequired').value = item.staffRequired || 0;
                document.getElementById('editItemModal').classList.add('active');
            }
        }
        async function updateItem() {
            const id = document.getElementById('editItemId').value;
            const name = document.getElementById('editItemName').value.trim();
            const desc = document.getElementById('editItemDesc').value.trim();
            const price = parseInt(document.getElementById('editItemPrice').value);
            const icon = document.getElementById('editItemIcon').value.trim();
            const type = document.getElementById('editItemType').value.trim();
            const energyProvides = parseInt(document.getElementById('editItemEnergyProvides').value);
            const energyCost = parseInt(document.getElementById('editItemEnergyCost').value);
            const colonistsProvides = parseInt(document.getElementById('editItemColonistsProvides').value);
            const foodProvides = parseInt(document.getElementById('editItemFoodProvides').value);
            const terraformBonus = parseInt(document.getElementById('editItemTerraformBonus').value);
            const production = document.getElementById('editItemProduction').checked;
            const unique = document.getElementById('editItemUnique').checked;
            const maxPerTeam = parseInt(document.getElementById('editItemMaxPerTeam').value);
            const effect = document.getElementById('editItemEffect').value;
            const staffRequired = parseInt(document.getElementById('editItemStaffRequired').value) || 0;

            if (!name || !price) return showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è', 'error');
            try { JSON.parse(effect); } catch { return showNotification('–≠—Ñ—Ñ–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º JSON', 'error'); }

            const formData = new FormData();
            formData.append('action', 'updateItem');
            formData.append('itemId', id);
            formData.append('name', name);
            formData.append('description', desc);
            formData.append('price', price);
            formData.append('icon', icon);
            formData.append('type', type);
            formData.append('energyProvides', energyProvides);
            formData.append('energyCost', energyCost);
            formData.append('colonistsProvides', colonistsProvides);
            formData.append('foodProvides', foodProvides);
            formData.append('terraformBonus', terraformBonus);
            formData.append('production', production);
            formData.append('unique', unique);
            formData.append('maxPerTeam', maxPerTeam);
            formData.append('effect', effect);
            formData.append('staffRequired', staffRequired);
            formData.append('password', currentState.adminPassword);

            try {
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                    closeModal('editItemModal');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞', 'error'); }
        }
        async function deleteItem() {
            const id = document.getElementById('editItemId').value;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
            const formData = new FormData();
            formData.append('action', 'deleteItem');
            formData.append('itemId', id);
            formData.append('password', currentState.adminPassword);
            try {
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω', 'success');
                    closeModal('editItemModal');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞', 'error'); }
        }

        function showAddEventModal() {
            document.getElementById('eventModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ';
            document.getElementById('editEventId').value = '';
            document.getElementById('eventName').value = '';
            document.getElementById('eventType').value = 'positive';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventEffect').value = '{\n  "type": "incomeBoost",\n  "target": "–¥–æ–±—ã—á–∞",\n  "value": 0.1\n}';
            document.getElementById('addEventModal').classList.add('active');
        }

        function openEditEventModal(id) {
            const event = currentState.events.find(e => e.id == id);
            if (!event) return;
            document.getElementById('eventModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ';
            document.getElementById('editEventId').value = event.id;
            document.getElementById('eventName').value = event.name;
            document.getElementById('eventType').value = event.type;
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('eventEffect').value = JSON.stringify(event.effect, null, 2);
            document.getElementById('addEventModal').classList.add('active');
        }

        async function saveEvent() {
            const id = document.getElementById('editEventId').value;
            const name = document.getElementById('eventName').value.trim();
            const type = document.getElementById('eventType').value;
            const description = document.getElementById('eventDescription').value.trim();
            const effect = document.getElementById('eventEffect').value;

            if (!name) return showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
            try { JSON.parse(effect); } catch { return showNotification('–≠—Ñ—Ñ–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º JSON', 'error'); }

            const action = id ? 'updateEvent' : 'addEvent';
            const formData = new FormData();
            formData.append('action', action);
            if (id) formData.append('eventId', id);
            formData.append('name', name);
            formData.append('type', type);
            formData.append('description', description);
            formData.append('effect', effect);
            formData.append('password', currentState.adminPassword);

            try {
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–°–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
                    closeModal('addEventModal');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function deleteEvent(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ?')) return;
            const formData = new FormData();
            formData.append('action', 'deleteEvent');
            formData.append('eventId', id);
            formData.append('password', currentState.adminPassword);
            try {
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function showTeamInventory(teamId) {
            const team = currentState.allTeams.find(t => t.id == teamId);
            if (!team) return;
            document.getElementById('inventoryTeamName').textContent = `–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å ${team.name}`;
            document.getElementById('inventoryList').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            document.getElementById('inventoryModal').classList.add('active');

            try {
                const res = await fetch(`${CONFIG.SCRIPT_URL}?action=getTeamInventory&teamId=${teamId}`);
                const data = await res.json();
                if (data.success && data.data.items) {
                    const items = data.data.items;
                    let html = '<ul class="inventory-list" style="list-style: none; padding:0;">';
                    if (items.length) {
                        items.forEach(item => {
                            let actions = '';
                            if (item.status === '—Å—Ç—Ä–æ–∏—Ç—Å—è') {
                                actions = `<button class="btn btn-success btn-icon" onclick="updatePurchaseStatus(${item.purchaseId}, '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç')" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ"><i class="fas fa-check"></i></button>`;
                            } else if (item.status === '–∫—É–ø–ª–µ–Ω–æ') {
                                actions = `<button class="btn btn-warning btn-icon" onclick="updatePurchaseStatus(${item.purchaseId}, '—Å—Ç—Ä–æ–∏—Ç—Å—è')" title="–ù–∞—á–∞—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ"><i class="fas fa-play"></i></button>`;
                            }
                            html += `<li class="inventory-item" data-purchase-id="${item.purchaseId}" style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
                                <i class="${item.icon}" style="width:30px; color:var(--neon-cyan);"></i>
                                <div style="flex:1;"><strong>${item.name}</strong> ‚Äî ${item.description}</div>
                                <div><span class="status-badge ${item.status}">${item.status}</span></div>
                                <div>${actions}</div>
                            </li>`;
                        });
                    } else {
                        html += '<li>–ù–µ—Ç –∑–¥–∞–Ω–∏–π</li>';
                    }
                    html += '</ul>';
                    document.getElementById('inventoryList').innerHTML = html;
                } else {
                    document.getElementById('inventoryList').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                }
            } catch (e) {
                document.getElementById('inventoryList').innerHTML = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
                showNotification('–û—à–∏–±–∫–∞', 'error');
            }
        }

        async function updatePurchaseStatus(purchaseId, newStatus) {
            if (!confirm(`–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∑–¥–∞–Ω–∏–µ –≤ —Å—Ç–∞—Ç—É—Å "${newStatus}"?`)) return;
            try {
                const formData = new FormData();
                formData.append('action', 'updatePurchaseStatus');
                formData.append('purchaseId', purchaseId);
                formData.append('status', newStatus);
                formData.append('password', currentState.adminPassword);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
                    const inventoryList = document.getElementById('inventoryList');
                    if (inventoryList) {
                        const itemElement = inventoryList.querySelector(`li[data-purchase-id="${purchaseId}"]`);
                        if (itemElement) {
                            const statusSpan = itemElement.querySelector('.status-badge');
                            if (statusSpan) {
                                statusSpan.className = `status-badge ${newStatus}`;
                                statusSpan.textContent = newStatus;
                            }
                            const actionsDiv = itemElement.querySelector('div:last-child');
                            if (actionsDiv) {
                                if (newStatus === '—Å—Ç—Ä–æ–∏—Ç—Å—è') {
                                    actionsDiv.innerHTML = `<button class="btn btn-success btn-icon" onclick="updatePurchaseStatus(${purchaseId}, '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç')" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ"><i class="fas fa-check"></i></button>`;
                                } else if (newStatus === '–∫—É–ø–ª–µ–Ω–æ') {
                                    actionsDiv.innerHTML = `<button class="btn btn-warning btn-icon" onclick="updatePurchaseStatus(${purchaseId}, '—Å—Ç—Ä–æ–∏—Ç—Å—è')" title="–ù–∞—á–∞—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ"><i class="fas fa-play"></i></button>`;
                                } else {
                                    actionsDiv.innerHTML = '';
                                }
                            }
                        }
                    }
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function processRoundIncome() {
            if (!confirm('–ù–∞—á–∏—Å–ª–∏—Ç—å –¥–æ—Ö–æ–¥ –∑–∞ —Å–µ–∑–æ–Ω –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º?')) return;
            try {
                const formData = new FormData();
                formData.append('action', 'processRoundIncome');
                formData.append('password', currentState.adminPassword);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–î–æ—Ö–æ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω', 'success');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function spinWheel() {
            const season = document.getElementById('wheelSeason').value;
            if (!confirm(`–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã –¥–ª—è —Å–µ–∑–æ–Ω–∞ ${season}?`)) return;
            try {
                const formData = new FormData();
                formData.append('action', 'spinWheel');
                formData.append('season', season);
                formData.append('password', currentState.adminPassword);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification(`–°–æ–±—ã—Ç–∏–µ: ${result.data.event.name}`, 'success');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function assignContract() {
            const teamId = document.getElementById('teamContractSelect').value;
            if (!teamId) return showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É', 'warning');
            try {
                const formData = new FormData();
                formData.append('action', 'assignContract');
                formData.append('teamId', teamId);
                formData.append('password', currentState.adminPassword);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω', 'success');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function advanceEpoch() {
            if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é —ç–ø–æ—Ö—É?')) return;
            if (!currentState.isAdmin) {
                showNotification('–¢–æ–ª—å–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å —ç–ø–æ—Ö—É', 'error');
                return;
            }
            try {
                const formData = new FormData();
                formData.append('action', 'advanceEpoch');
                formData.append('password', currentState.adminPassword);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification(`–≠–ø–æ—Ö–∞ ${result.data.newEpoch} –∑–∞–ø—É—â–µ–Ω–∞`, 'success');
                    loadAdminData();
                    if (currentState.team) loadTeamData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        async function setBeautyFactor(teamId, value) {
            if (!value) return;
            const num = parseFloat(value);
            if (isNaN(num) || num < 0.5 || num > 1.5) {
                showNotification('–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0.5 –¥–æ 1.5', 'warning');
                return;
            }
            try {
                const formData = new FormData();
                formData.append('action', 'setBeautyFactor');
                formData.append('teamId', teamId);
                formData.append('value', num);
                formData.append('password', currentState.adminPassword);
                const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showNotification('–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
                    loadAdminData();
                } else {
                    showNotification(result.data.error || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) { showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
        }

        window.switchAdminTab = (tab) => {
            document.querySelectorAll('#adminScreen .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('adminTeamsTab').style.display = tab === 'teams' ? 'block' : 'none';
            document.getElementById('adminShopTab').style.display = tab === 'shop' ? 'block' : 'none';
            document.getElementById('adminEventsTab').style.display = tab === 'events' ? 'block' : 'none';
            document.getElementById('adminFinalTab').style.display = tab === 'final' ? 'block' : 'none';
            document.getElementById('adminStatsTab').style.display = tab === 'stats' ? 'block' : 'none';
            if (tab !== 'teams') loadAdminData();
        };

        let refreshInterval;
        function startAutoRefresh() {
            stopAutoRefresh();
            refreshInterval = setInterval(() => {
                if (currentState.team) loadTeamData();
                else if (currentState.isAdmin) loadAdminData();
            }, CONFIG.REFRESH_INTERVAL);
        }
        function stopAutoRefresh() { if (refreshInterval) clearInterval(refreshInterval); }

        window.refreshTeamData = loadTeamData;
        window.refreshAdminData = loadAdminData;
    </script>
</body>
</html>



